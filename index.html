<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DesativaÃ§Ã£o de Chamado</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
.container { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.loading { color: #007bff; }
.success { color: #28a745; }
.error { color: #dc3545; }
.device-info { color: #666; font-size: 12px; margin-top: 10px; }
.btn { margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
.btn:hover { background: #0056b3; }
</style>
</head>
<body>
<div class="container">
<h2>ğŸ”„ Processando...</h2>
<p class="loading">Aguarde, desativando chamado...</p>
<div class="device-info" id="deviceInfo"></div>
</div>

<script>
const NOTIFY_RUN_CHANNEL = "https://notify.run/c/RfqySBx93hSnzsZONI6q";
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

const showStatus = (message, type='loading', showRetry=false) => {
    const container=document.querySelector('.container');
    if(!container) return;
    const deviceText = isMobile?'ğŸ“± Dispositivo mÃ³vel detectado':'ğŸ–¥ï¸ Dispositivo desktop detectado';
    const retryButton = showRetry?`<button class="btn" onclick="window.location.reload()">ğŸ”„ Tentar Novamente</button>`:'';
    let icon='ğŸ”„', title='Processando...', bgColor='#f0f0f0';
    if(type==='success'){icon='âœ…';title='Sucesso!';bgColor='#f0fff0';}
    else if(type==='error'){icon='âŒ';title='Erro';bgColor='#fff0f0';}
    document.body.style.background=bgColor;
    container.innerHTML=`<h2>${icon} ${title}</h2>
        <p class="${type}">${message}</p>
        <div class="device-info">${deviceText}</div>
        ${retryButton}
        <p style="color:#666;font-size:12px;margin-top:20px;">VocÃª pode fechar esta aba.</p>`;
};

// --------- ExtensÃ£o Desktop ---------
const tentarDesativarViaExtensao = (ticket) => {
    return new Promise((resolve,reject)=>{
        console.log('ğŸ–¥ï¸ Tentando desativar via extensÃ£o...');
        let responseReceived=false;
        const responseHandler = (event)=>{
            if(event.data && event.data.action==='desativarResponse' && event.data.ticket===ticket){
                responseReceived=true;
                window.removeEventListener('message', responseHandler);
                if(event.data.status==='success'){
                    console.log('âœ… Desativado via extensÃ£o!');
                    resolve(true);
                } else {
                    reject(new Error('Erro na extensÃ£o: '+(event.data.error||'Desconhecido')));
                }
            }
        };
        window.addEventListener('message', responseHandler);
        window.postMessage({action:'desativar', ticket:ticket},'*');
        setTimeout(()=>{
            if(!responseReceived){
                window.removeEventListener('message', responseHandler);
                reject(new Error('ExtensÃ£o nÃ£o disponÃ­vel'));
            }
        },2000);
    });
};

// --------- notify.run ---------
const desativarViaNotifyRun = async(ticket)=>{
    const maxTentativas=3;
    const timeout=isMobile?5000:3000;
    for(let t=1;t<=maxTentativas;t++){
        try{
            console.log(`ğŸ“± Tentativa ${t}/${maxTentativas} via notify.run`);
            const controller=new AbortController();
            const timeoutId=setTimeout(()=>controller.abort(), timeout);
            const payload = { action:"desativar", ticket:ticket };
            const response = await fetch(NOTIFY_RUN_CHANNEL,{
                method:'POST',
                body:JSON.stringify(payload),
                signal:controller.signal,
                headers:{
                    'Content-Type':'application/json',
                    'User-Agent':isMobile?'Mobile-Desativador':'Desktop-Desativador'
                }
            });
            clearTimeout(timeoutId);
            console.log('HTTP status:', response.status);
            if(!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return true;
        }catch(err){
            console.warn(`âš ï¸ Tentativa ${t} falhou:`,err.message);
            if(t===maxTentativas) throw new Error(`Falha apÃ³s ${t} tentativas: ${err.message}`);
            await new Promise(r=>setTimeout(r,1000*t));
        }
    }
};

// --------- FunÃ§Ã£o principal ---------
const desativarChamado = async(ticket)=>{
    try{
        await tentarDesativarViaExtensao(ticket);
        return 'extensao';
    }catch(extError){
        console.log('âš ï¸ ExtensÃ£o nÃ£o disponÃ­vel:', extError.message);
        try{
            await desativarViaNotifyRun(ticket);
            return 'notify.run';
        }catch(notifyError){
            throw new Error(`Falha em ambos os mÃ©todos. ExtensÃ£o: ${extError.message}. notify.run: ${notifyError.message}`);
        }
    }
};

const main=async()=>{
    try{
        await new Promise(r=>setTimeout(r,100));
        const deviceInfo=document.getElementById('deviceInfo');
        if(deviceInfo) deviceInfo.textContent=isMobile?'ğŸ“± Dispositivo mÃ³vel detectado':'ğŸ–¥ï¸ Dispositivo desktop detectado';
        const urlParams=new URLSearchParams(window.location.search);
        const ticket=urlParams.get('ticket');
        if(!ticket){showStatus('NÃºmero do chamado nÃ£o encontrado na URL.','error',true); return;}
        console.log(`Iniciando desativaÃ§Ã£o do ticket #${ticket}`);
        showStatus(`Desativando chamado #${ticket}...`);
        const metodo = await desativarChamado(ticket);
        const metodoTexto = metodo==='extensao'?'via extensÃ£o (PC)':'via notify.run';
        showStatus(`Chamado #${ticket} foi desativado com sucesso ${metodoTexto}!`,'success');
        setTimeout(()=>window.close(),1500);
    }catch(err){
        console.error('Erro geral:', err);
        showStatus(`Erro ao desativar chamado: ${err.message}`,'error',true);
    }
};

document.addEventListener('DOMContentLoaded',main);
</script>
</body>
</html>
