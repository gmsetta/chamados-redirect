<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desativação de Chamado (Debug Completo)</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
.container { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.loading { color: #007bff; }
.success { color: #28a745; }
.error { color: #dc3545; }
.device-info { color: #666; font-size: 12px; margin-top: 10px; }
.btn { margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
.btn:hover { background: #0056b3; }
</style>
</head>
<body>
<div class="container">
<h2>🔄 Processando...</h2>
<p class="loading">Aguarde, desativando chamado...</p>
<div class="device-info" id="deviceInfo"></div>
</div>

<script>
// Fecha automaticamente
/*setTimeout(() => {
    window.close();
}, 1500);*/


const NTFY_TOPICS = [
    'atualizador-maximo-gmsetta-tickets-v5-01',
    'atualizador-maximo-gmsetta-tickets-v5-02',
    'atualizador-maximo-gmsetta-tickets-v5-03'
];
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

const getNtfyTopic = (ticket) => {
    const ticketNum = parseInt(ticket)||0;
    const index = ticketNum % NTFY_TOPICS.length;
    return NTFY_TOPICS[index];
};
const getNtfyUrl = (ticket) => `https://ntfy.sh/${getNtfyTopic(ticket)}`;

const showStatus = (message, type='loading', showRetry=false)=>{
    const container=document.querySelector('.container');
    if(!container) return;
    const deviceText = isMobile?'📱 Dispositivo móvel detectado':'🖥️ Dispositivo desktop detectado';
    const retryButton = showRetry?`<button class="btn" onclick="window.location.reload()">🔄 Tentar Novamente</button>`:'';
    let icon='🔄', title='Processando...', bgColor='#f0f0f0';
    if(type==='success'){icon='✅';title='Sucesso!';bgColor='#f0fff0';}
    else if(type==='error'){icon='❌';title='Erro';bgColor='#fff0f0';}
    document.body.style.background=bgColor;
    container.innerHTML=`<h2>${icon} ${title}</h2>
        <p class="${type}">${message}</p>
        <div class="device-info">${deviceText}</div>
        ${retryButton}
        <p style="color:#666;font-size:12px;margin-top:20px;">Você pode fechar esta aba.</p>`;
};

// --------- Extensão Desktop (VERSÃO SIMPLIFICADA SEM ID) ---------
const tentarDesativarViaExtensao = (ticket) => {
    return new Promise((resolve, reject) => {
        console.log('🖥️ Tentando desativar via extensão...');
        
        let responseReceived = false;
        
        // Listener para resposta da extensão
        const responseHandler = (event) => {
            if (event.data && 
                event.data.action === 'desativarResponse' && 
                event.data.ticket === ticket) {
                
                responseReceived = true;
                window.removeEventListener('message', responseHandler);
                
                if (event.data.status === 'success') {
                    console.log('✅ Desativado via extensão!');
                    resolve(true);
                } else {
                    reject(new Error('Erro na extensão: ' + (event.data.error || event.data.message || 'Desconhecido')));
                }
            }
        };
        
        // Adiciona listener
        window.addEventListener('message', responseHandler);
        
        // Envia mensagem para a extensão
        console.log('📤 Enviando mensagem para extensão via postMessage...');
        window.postMessage({
            action: 'desativar',
            ticket: ticket
        }, '*');
        
        // Timeout de 3 segundos
        setTimeout(() => {
            if (!responseReceived) {
                window.removeEventListener('message', responseHandler);
                reject(new Error('Extensão não respondeu (timeout)'));
            }
        }, 3000);
    });
};

// --------- ntfy.sh ---------
const desativarViaNtfy = async(ticket)=>{
    const maxTentativas=3;
    const timeout=isMobile?5000:3000;
    for(let t=1;t<=maxTentativas;t++){
        try{
            console.log(`📱 Tentativa ${t}/${maxTentativas} via ntfy.sh`);
            const controller=new AbortController();
            const timeoutId=setTimeout(()=>controller.abort(), timeout);
            const url=getNtfyUrl(ticket);
            console.log('URL:', url);
            console.log('Headers: Content-Type=text/plain; charset=utf-8, User-Agent=',isMobile?'Mobile-Desativador':'Desktop-Desativador');
            console.log('Body:', ticket);
            const response = await fetch(url,{
                method:'POST',
                body:ticket,
                signal:controller.signal,
                headers:{
                    'Content-Type':'text/plain; charset=utf-8',
                    'User-Agent':isMobile?'Mobile-Desativador':'Desktop-Desativador'
                }
            });
            clearTimeout(timeoutId);
            console.log('HTTP status:', response.status);
            const text = await response.text();
            console.log('Resposta do servidor:', text);
            if(!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return true;
        }catch(err){
            console.warn(`⚠️ Tentativa ${t} falhou:`,err.message);
            if(t===maxTentativas) throw new Error(`Falha após ${t} tentativas: ${err.message}`);
            await new Promise(r=>setTimeout(r,1000*t));
        }
    }
};

// --------- Função principal ---------
const desativarChamado = async(ticket)=>{
    try{
        await tentarDesativarViaExtensao(ticket);
        return 'extensao';
    }catch(extError){
        console.log('⚠️ Extensão não disponível:', extError.message);
        try{
            await desativarViaNtfy(ticket);
            return 'ntfy';
        }catch(ntfyError){
            throw new Error(`Falha em ambos os métodos. Extensão: ${extError.message}. ntfy.sh: ${ntfyError.message}`);
        }
    }
};

const main=async()=>{
    try{
        await new Promise(r=>setTimeout(r,100));
        const deviceInfo=document.getElementById('deviceInfo');
        if(deviceInfo) deviceInfo.textContent=isMobile?'📱 Dispositivo móvel detectado':'🖥️ Dispositivo desktop detectado';
        const urlParams=new URLSearchParams(window.location.search);
        const ticket=urlParams.get('ticket');
        if(!ticket){showStatus('Número do chamado não encontrado na URL.','error',true); return;}
        console.log(`Iniciando desativação do ticket #${ticket}`);
        showStatus(`Desativando chamado #${ticket}...`);
        const metodo = await desativarChamado(ticket);
        const metodoTexto = metodo==='extensao'?'via extensão (PC)':'via ntfy.sh (mobile)';
        showStatus(`Chamado #${ticket} foi desativado com sucesso ${metodoTexto}!`,'success');
        setTimeout(()=>window.close(),1500);
    }catch(err){
        console.error('Erro geral:', err);
        showStatus(`Erro ao desativar chamado: ${err.message}`,'error',true);
    }
};

document.addEventListener('DOMContentLoaded',main);
</script>
</body>
</html>
