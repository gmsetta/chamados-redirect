<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desativa√ß√£o de Chamado</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
.container { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.loading { color: #007bff; }
.success { color: #28a745; }
.error { color: #dc3545; }
.device-info { color: #666; font-size: 12px; margin-top: 10px; }
.btn { margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
.btn:hover { background: #0056b3; }
</style>
</head>
<body>
<div class="container">
<h2>üîÑ Processando...</h2>
<p class="loading">Aguarde, desativando chamado...</p>
<div class="device-info" id="deviceInfo"></div>
</div>
<script>
const NTFY_TOPICS = [
    'atualizador-maximo-gmsetta-tickets-v5-01',
    'atualizador-maximo-gmsetta-tickets-v5-02',
    'atualizador-maximo-gmsetta-tickets-v5-03'
];

const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

function getNtfyTopic(ticket) {
    const ticketNum = parseInt(ticket)||0;
    return NTFY_TOPICS[ticketNum % NTFY_TOPICS.length];
}

function getNtfyUrl(ticket) {
    return `https://ntfy.sh/${getNtfyTopic(ticket)}`;
}

function showStatus(message, type='loading', showRetry=false) {
    const container = document.querySelector('.container');
    if (!container) return;
    const deviceText = isMobile?'üì± Dispositivo m√≥vel detectado':'üñ•Ô∏è Dispositivo desktop detectado';
    const retryButton = showRetry?`<button class="btn" onclick="window.location.reload()">üîÑ Tentar Novamente</button>`:'';
    let icon='üîÑ', title='Processando...', bgColor='#f0f0f0';
    if(type==='success'){icon='‚úÖ';title='Sucesso!';bgColor='#f0fff0';}
    else if(type==='error'){icon='‚ùå';title='Erro';bgColor='#fff0f0';}
    document.body.style.background=bgColor;
    container.innerHTML=`<h2>${icon} ${title}</h2>
        <p class="${type}">${message}</p>
        <div class="device-info">${deviceText}</div>
        ${retryButton}
        <p style="color:#666;font-size:12px;margin-top:20px;">Voc√™ pode fechar esta aba.</p>`;
}

// --- Fila global de tickets ---
const ticketQueue = [];
let queueWorkerActive = false;
function enqueueTicket(ticket, resolve, reject) {
    ticketQueue.push({ticket, resolve, reject});
    processQueue();
}
function processQueue() {
    if (queueWorkerActive || ticketQueue.length === 0) return;
    queueWorkerActive = true;
    const processNext = async () => {
        if (ticketQueue.length === 0) { queueWorkerActive = false; return; }
        const {ticket, resolve, reject} = ticketQueue.shift();
        try { await desativarViaNtfy(ticket); resolve(true); }
        catch(err) { reject(err); }
        setTimeout(processNext, 5000);
    };
    processNext();
}

// --- Tenta via extens√£o ---
function tentarDesativarViaExtensao(ticket) {
    return new Promise((resolve, reject) => {
        let responded = false;
        const handler = (event) => {
            if (event.data?.action==='desativarResponse' && event.data.ticket===ticket) {
                responded = true;
                window.removeEventListener('message', handler);
                event.data.status==='success'?resolve(true):reject(new Error(event.data.error||'Erro desconhecido'));
            }
        };
        window.addEventListener('message', handler);
        window.postMessage({action:'desativar',ticket},'*');
        setTimeout(()=>{ if(!responded){ window.removeEventListener('message', handler); reject(new Error('Extens√£o n√£o respondeu (timeout)')); } }, 3000);
    });
}

// --- Desativa via ntfy.sh ---
async function desativarViaNtfy(ticket) {
    const maxTent=3, timeout=isMobile?5000:3000;
    for(let t=1;t<=maxTent;t++){
        try{
            const controller=new AbortController();
            const timeoutId=setTimeout(()=>controller.abort(), timeout);
            const url=getNtfyUrl(ticket);
            const response = await fetch(url,{method:'POST',body:ticket,signal:controller.signal,headers:{'Content-Type':'text/plain; charset=utf-8','User-Agent':isMobile?'Mobile-Desativador':'Desktop-Desativador'}});
            clearTimeout(timeoutId);
            if(!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return true;
        }catch(err){ if(t===maxTent) throw new Error(`Falha ap√≥s ${t} tentativas: ${err.message}`); await new Promise(r=>setTimeout(r,1000*t)); }
    }
}

// --- Chamado ---
async function desativarChamado(ticket){
    try{ await tentarDesativarViaExtensao(ticket); return 'extensao'; }
    catch(extError){ return new Promise((resolve,reject)=>{
        enqueueTicket(ticket, ()=>resolve('ntfy'), err=>reject(new Error(`Falha em ambos m√©todos. Extens√£o: ${extError.message}. ntfy.sh: ${err.message}`)));
    }); }
}

// --- Main ---
async function main(){
    await new Promise(r=>setTimeout(r,100));
    const deviceInfo=document.getElementById('deviceInfo');
    if(deviceInfo) deviceInfo.textContent=isMobile?'üì± Dispositivo m√≥vel detectado':'üñ•Ô∏è Dispositivo desktop detectado';
    const ticket=new URLSearchParams(window.location.search).get('ticket');
    if(!ticket){ showStatus('N√∫mero do chamado n√£o encontrado na URL.','error',true); return; }
    showStatus(`Desativando chamado #${ticket}...`);
    try{
        const metodo=await desativarChamado(ticket);
        const metodoTexto=metodo==='extensao'?'via extens√£o (PC)':'via ntfy.sh (mobile)';
        showStatus(`Chamado #${ticket} desativado com sucesso ${metodoTexto}!`,'success');
        setTimeout(()=>window.close(),1500);
    }catch(err){
        showStatus(`Erro ao desativar chamado: ${err.message}`,'error',true);
    }
}

document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
